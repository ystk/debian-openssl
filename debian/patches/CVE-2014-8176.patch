From b79e6e3a276634582012d531f4150a5fcf84fab3 Mon Sep 17 00:00:00 2001
From: zhu qun-ying <qunying@yahoo.com>
Date: Mon, 2 Jun 2014 14:38:52 +0100
Subject: [PATCH] Free up s->d1->buffered_app_data.q properly.

PR#3286
(cherry picked from commit 71e95000afb2227fe5cac1c79ae884338bcd8d0b)
---
 ssl/d1_lib.c | 9 ++++++---
 1 file changed, 6 insertions(+), 3 deletions(-)

Index: openssl-0.9.8o/ssl/d1_lib.c
===================================================================
--- openssl-0.9.8o.orig/ssl/d1_lib.c	2015-06-17 21:23:00.000000000 +0000
+++ openssl-0.9.8o/ssl/d1_lib.c	2015-06-17 21:26:24.234241419 +0000
@@ -149,6 +149,7 @@
 	{
     pitem *item = NULL;
     hm_fragment *frag = NULL;
+    DTLS1_RECORD_DATA *rdata;
 
 	ssl3_free(s);
 
@@ -186,9 +187,12 @@
 
 	while ( (item = pqueue_pop(s->d1->buffered_app_data.q)) != NULL)
 	{
-		frag = (hm_fragment *)item->data;
-		OPENSSL_free(frag->fragment);
-		OPENSSL_free(frag);
+                rdata = (DTLS1_RECORD_DATA *) item->data;
+                if (rdata->rbuf.buf)
+                        {
+                        OPENSSL_free(rdata->rbuf.buf);
+                        }
+                OPENSSL_free(item->data);
 		pitem_free(item);
 	}
 	pqueue_free(s->d1->buffered_app_data.q);
