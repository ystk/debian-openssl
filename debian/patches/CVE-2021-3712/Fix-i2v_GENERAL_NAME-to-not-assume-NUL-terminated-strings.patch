From: Matt Caswell <matt@openssl.org>
Date: Wed, 18 Aug 2021 12:24:22 +0100
Subject: Fix i2v_GENERAL_NAME to not assume NUL terminated strings

ASN.1 strings may not be NUL terminated. Don't assume they are.
---
 crypto/include/internal/x509_int.h |  5 +++++
 crypto/x509v3/v3_alt.c             | 10 +++++++---
 crypto/x509v3/v3_utl.c             | 35 +++++++++++++++++++++++++++++------
 3 files changed, 41 insertions(+), 9 deletions(-)

Index: openssl-1.0.1t/crypto/x509v3/v3_alt.c
===================================================================
--- openssl-1.0.1t.orig/crypto/x509v3/v3_alt.c	2021-10-22 16:03:06.331764564 +0200
+++ openssl-1.0.1t/crypto/x509v3/v3_alt.c	2021-10-22 16:06:38.035796169 +0200
@@ -131,15 +131,15 @@
         break;
 
     case GEN_EMAIL:
-        X509V3_add_value_uchar("email", gen->d.ia5->data, &ret);
+        x509v3_add_len_value_uchar("email", gen->d.ia5->data, gen->d.ia5->length, &ret);
         break;
 
     case GEN_DNS:
-        X509V3_add_value_uchar("DNS", gen->d.ia5->data, &ret);
+        x509v3_add_len_value_uchar("DNS", gen->d.ia5->data, gen->d.ia5->length, &ret);
         break;
 
     case GEN_URI:
-        X509V3_add_value_uchar("URI", gen->d.ia5->data, &ret);
+        x509v3_add_len_value_uchar("URI", gen->d.ia5->data, gen->d.ia5->length, &ret);
         break;
 
     case GEN_DIRNAME:
Index: openssl-1.0.1t/crypto/x509v3/v3_utl.c
===================================================================
--- openssl-1.0.1t.orig/crypto/x509v3/v3_utl.c	2021-10-22 16:03:06.331764564 +0200
+++ openssl-1.0.1t/crypto/x509v3/v3_utl.c	2021-10-22 16:03:06.331764564 +0200
@@ -59,6 +59,7 @@
 /* X509 v3 extension utilities */
 
 #include <stdio.h>
+#include <string.h>
 #include <ctype.h>
 #include "cryptlib.h"
 #include <openssl/conf.h>
@@ -79,15 +80,22 @@
 
 /* Add a CONF_VALUE name value pair to stack */
 
-int X509V3_add_value(const char *name, const char *value,
-                     STACK_OF(CONF_VALUE) **extlist)
+static int x509v3_add_len_value(const char *name, const char *value,
+                                size_t vallen, STACK_OF(CONF_VALUE) **extlist)
 {
     CONF_VALUE *vtmp = NULL;
     char *tname = NULL, *tvalue = NULL;
-    if (name && !(tname = BUF_strdup(name)))
-        goto err;
-    if (value && !(tvalue = BUF_strdup(value)))
+    if (name != NULL && !(tname = BUF_strdup(name)))
         goto err;
+    if (value != NULL) {
+        /* We don't allow embeded NUL characters */
+        if (memchr(value, 0, vallen) != NULL)
+            goto err;
+        tvalue = BUF_strndup(value, vallen);
+        if (tvalue == NULL)
+            goto err;
+    }
+
     if (!(vtmp = (CONF_VALUE *)OPENSSL_malloc(sizeof(CONF_VALUE))))
         goto err;
     if (!*extlist && !(*extlist = sk_CONF_VALUE_new_null()))
@@ -109,10 +117,26 @@
     return 0;
 }
 
+int X509V3_add_value(const char *name, const char *value,
+                     STACK_OF(CONF_VALUE) **extlist)
+{
+    return x509v3_add_len_value(name, value,
+                                value != NULL ? strlen((const char *)value) : 0,
+                                extlist);
+}
+
 int X509V3_add_value_uchar(const char *name, const unsigned char *value,
                            STACK_OF(CONF_VALUE) **extlist)
 {
-    return X509V3_add_value(name, (const char *)value, extlist);
+    return x509v3_add_len_value(name, (const char *)value,
+                                value != NULL ? strlen((const char *)value) : 0,
+                                extlist);
+}
+
+int x509v3_add_len_value_uchar(const char *name, const unsigned char *value,
+                               size_t vallen, STACK_OF(CONF_VALUE) **extlist)
+{
+    return x509v3_add_len_value(name, (const char *)value, vallen, extlist);
 }
 
 /* Free function for STACK_OF(CONF_VALUE) */
Index: openssl-1.0.1t/crypto/x509v3/x509v3.h
===================================================================
--- openssl-1.0.1t.orig/crypto/x509v3/x509v3.h	2021-10-22 16:03:06.331764564 +0200
+++ openssl-1.0.1t/crypto/x509v3/x509v3.h	2021-10-22 16:03:06.331764564 +0200
@@ -711,6 +711,10 @@
 ASN1_OCTET_STRING *a2i_IPADDRESS(const char *ipasc);
 ASN1_OCTET_STRING *a2i_IPADDRESS_NC(const char *ipasc);
 int a2i_ipadd(unsigned char *ipout, const char *ipasc);
+
+int x509v3_add_len_value_uchar(const char *name, const unsigned char *value,
+                              size_t vallen, STACK_OF(CONF_VALUE) **extlist);
+
 int X509V3_NAME_from_section(X509_NAME *nm, STACK_OF(CONF_VALUE) *dn_sk,
                              unsigned long chtype);
 
