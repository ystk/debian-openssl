From: Matt Caswell <matt@openssl.org>
Date: Mon, 23 Aug 2021 13:56:22 +0100
Subject: fixup! Allow fuzz builds to detect string overruns

---
 crypto/asn1/asn1_lib.c | 15 ++++++++-------
 1 file changed, 8 insertions(+), 7 deletions(-)

Index: openssl-1.0.1t/crypto/asn1/asn1_lib.c
===================================================================
--- openssl-1.0.1t.orig/crypto/asn1/asn1_lib.c	2021-10-22 16:19:50.443889478 +0200
+++ openssl-1.0.1t/crypto/asn1/asn1_lib.c	2021-10-22 16:19:50.439889478 +0200
@@ -381,8 +381,14 @@
         c = str->data;
         if (c == NULL)
             str->data = OPENSSL_malloc(len + 1);
-        else
+        else {
+#ifdef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION
+            /* No NUL terminator in fuzzing builds */
+            str->data = OPENSSL_realloc(c, len);
+#else   
             str->data = OPENSSL_realloc(c, len + 1);
+#endif  
+        }
 
         if (str->data == NULL) {
             ASN1err(ASN1_F_ASN1_STRING_SET, ERR_R_MALLOC_FAILURE);
@@ -393,15 +399,11 @@
     str->length = len;
     if (data != NULL) {
         memcpy(str->data, data, len);
-        /* an allowance for strings :-) */
-#ifdef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION
+#ifndef FUZZING_BUILD_MODE_UNSAFE_FOR_PRODUCTION
         /*
-         * Arbitrary byte on the end, which should never be read if the string
-         * length is being properly respected.
+         * Add a NUL terminator. This should not be necessary - but we add it as
+         * a safety precaution
          */
-        str->data[len] = 'x';
-#else
-        /* This should not be necessary - but we add it as a safety precaution */
         str->data[len] = '\0';
 #endif
     }
