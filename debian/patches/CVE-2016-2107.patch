From 4159f311671cf3bac03815e5de44681eb758304a Mon Sep 17 00:00:00 2001
From: Kurt Roeckx <kurt@roeckx.be>
Date: Sat, 16 Apr 2016 23:08:56 +0200
Subject: [PATCH] Check that we have enough padding characters.
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Reviewed-by: Emilia KÃ¤sper <emilia@openssl.org>

CVE-2016-2107

MR: #2572
---
 crypto/evp/e_aes_cbc_hmac_sha1.c | 3 +++
 1 file changed, 3 insertions(+)

Index: openssl-1.0.1k/crypto/evp/e_aes_cbc_hmac_sha1.c
===================================================================
--- openssl-1.0.1k.orig/crypto/evp/e_aes_cbc_hmac_sha1.c
+++ openssl-1.0.1k/crypto/evp/e_aes_cbc_hmac_sha1.c
@@ -59,6 +59,7 @@
 #include <openssl/aes.h>
 #include <openssl/sha.h>
 #include "evp_locl.h"
+#include "constant_time_locl.h"
 
 #ifndef EVP_CIPH_FLAG_AEAD_CIPHER
 #define EVP_CIPH_FLAG_AEAD_CIPHER	0x200000
@@ -278,6 +279,8 @@ static int aesni_cbc_hmac_sha1_cipher(EV
 			maxpad |= (255-maxpad)>>(sizeof(maxpad)*8-8);
 			maxpad &= 255;
 
+                        ret &= constant_time_ge(maxpad, pad);
+
 			inp_len = len - (SHA_DIGEST_LENGTH+pad+1);
 			mask = (0-((inp_len-len)>>(sizeof(inp_len)*8-1)));
 			inp_len &= mask;
